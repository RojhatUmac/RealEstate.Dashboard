@using RealEstate.Dashboard.Models
@using Microsoft.AspNetCore.Components.Forms


<MudDialog>

    <DialogContent>
        <MudText Typo="Typo.h6">Yeni Ev Ekle</MudText>

        <MudGrid Spacing="3">

            <MudItem xs="12">
                <MudTextField T="string"
                              Label="Başlık"
                              @bind-Value="_house.Title"
                              FullWidth />
            </MudItem>

            <MudItem xs="12" sm="6">
                <MudTextField T="string"
                              Label="Şehir"
                              @bind-Value="_house.City"
                              FullWidth />
            </MudItem>

            <MudItem xs="12" sm="6">
                <MudTextField T="decimal"
                              Label="Fiyat"
                              @bind-Value="_house.Price"
                              FullWidth />
            </MudItem>
            <MudText Typo="Typo.subtitle2" Class="mt-4">
                Ev Görseli
            </MudText>

            <InputFile OnChange="OnImageSelected" />
            <MudTextField T="string"
                          Label="Açıklama"
                          Lines="6"
                          TextArea="true"
                          @bind-Value="_house.Description"
                          FullWidth />
        </MudGrid>
    </DialogContent>

    <DialogActions>
        <MudButton Color="Color.Primary" OnClick="Save">Kaydet</MudButton>
        <MudButton OnClick="Cancel">İptal</MudButton>
    </DialogActions>

</MudDialog>

@code {

    // Evlerim sayfasından gönderilen ev
    [Parameter]
    public House? Model { get; set; }

    // MudBlazor dialog kontrolü
    [CascadingParameter]
    public IMudDialogInstance MudDialog { get; set; } = default!;

    // Formda kullanılan ev (kopya)
    House _house = new();

    protected override void OnInitialized()
    {
        // Eğer edit için gelindiyse (Model doluysa)
        if (Model is not null)
        {
            _house = new House
            {
                Id = Model.Id,
                Title = Model.Title,
                City = Model.City,
                Price = Model.Price
            };
        }
    }

    void Save()
    {
        MudDialog.Close(DialogResult.Ok(_house));
    }

    void Cancel()
    {
        MudDialog.Cancel();
    }
    async Task OnImageSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;

        if (file == null)
            return;

        using var stream = file.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024);
        using var ms = new MemoryStream();

        await stream.CopyToAsync(ms);

        var base64 = Convert.ToBase64String(ms.ToArray());
        _house.ImageUrl = $"data:{file.ContentType};base64,{base64}";
    }
}

