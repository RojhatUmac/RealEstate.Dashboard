@page "/houses"
@inject HouseState HouseState
@using MudBlazor
@using RealEstate.Dashboard.Components.Dialogs
@using RealEstate.Dashboard.Data
@using RealEstate.Dashboard.Models

@inject IDialogService DialogService
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.False">

    <!-- ÜST BAŞLIK + YENİ EKLE -->
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
        <MudText Typo="Typo.h5">Evlerim</MudText>

        <MudButton Color="Color.Primary"
                   Variant="Variant.Filled"
                   StartIcon="@Icons.Material.Filled.Add"
                   OnClick="OpenAddDialog">
            Yeni Ekle
        </MudButton>
    </MudStack>

    <!-- TABLO -->
    <MudTable Items="_houses" Hover="true" Class="mt-4">

        <HeaderContent>
            <MudTh>ID</MudTh>
            <MudTh>Başlık</MudTh>
            <MudTh>Şehir</MudTh>
            <MudTh>Fiyat</MudTh>
            <MudTh>İşlemler</MudTh>
        </HeaderContent>

        <RowTemplate Context="house">
            <MudTd>@house.Id</MudTd>

            <MudTd>
                <MudLink Href="@($"/houses/{house.Id}")">
                    @house.Title
                </MudLink>
            </MudTd>

            <MudTd>@house.City</MudTd>
            <MudTd>@house.Price ₺</MudTd>

            <MudTd>
                <MudIconButton Icon="@Icons.Material.Filled.Edit"
                               Color="Color.Primary"
                               OnClick="@(() => EditHouse(house))" />

                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                               Color="Color.Error"
                               OnClick="@(() => DeleteHouse(house))" />
            </MudTd>
        </RowTemplate>

    </MudTable>

</MudContainer>

@code {

    List<House> _houses => HouseState.Houses;
    bool? _activeFilter = true;
    IEnumerable<House> FilteredHouses =>
        _activeFilter is null
            ? HouseState.Houses
            : HouseState.Houses.Where(x => x.IsActive == _activeFilter);

    async Task OpenAddDialog()
    {
        var dialog = DialogService.Show<AddHouseDialog>("Yeni Ev");
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            var newHouse = (House)result.Data!;

            //  KRİTİK FIX
            newHouse.Id = _houses.Any()
                ? _houses.Max(x => x.Id) + 1
                : 1;

            _houses.Add(newHouse);
            HouseState.NotifyStateChanged();
            Snackbar.Add("Ev başarıyla eklendi", Severity.Success);
        }
    }

    void DeleteHouse(House house)
    {
        _houses.Remove(house);
        HouseState.NotifyStateChanged();
        Snackbar.Add($"{house.Title} silindi", Severity.Success);
    }

    async Task EditHouse(House house)
    {
        var parameters = new DialogParameters
    {
        { "Model", house }
    };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };

        var dialog = DialogService.Show<AddHouseDialog>(
            "Ev Güncelle",
            parameters,
            options);

        var result = await dialog.Result;

        if (!result.Canceled)
        {
            var updatedHouse = (House)result.Data!;

            var index = _houses.FindIndex(x => x.Id == updatedHouse.Id);
            if (index != -1)
            {
                _houses[index] = updatedHouse;
            }

            HouseState.NotifyStateChanged();
            Snackbar.Add("Ev başarıyla güncellendi", Severity.Success);
        }
    }
}
