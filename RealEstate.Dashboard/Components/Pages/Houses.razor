@page "/houses"

@using MudBlazor
@using RealEstate.Dashboard.Components.Dialogs
@using RealEstate.Dashboard.Models
@using RealEstate.Dashboard.Data

@inject IDialogService DialogService
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.False">

    <!-- ÜST BAŞLIK + YENİ EKLE -->
    <MudStack Row="true"
              Justify="Justify.SpaceBetween"
              AlignItems="AlignItems.Center">
        <MudText Typo="Typo.h5">Evlerim</MudText>

        <MudButton Color="Color.Primary"
                   Variant="Variant.Filled"
                   StartIcon="@Icons.Material.Filled.Add"
                   OnClick="OpenAddDialog">
            Yeni Ekle
        </MudButton>
    </MudStack>

    <!-- TABLO -->
    <MudTable Items="_houses" Hover="true" Class="mt-4">

        <!-- TABLO BAŞLIKLARI -->
        <HeaderContent>
            <MudTh>ID</MudTh>
            <MudTh>Başlık</MudTh>
            <MudTh>Şehir</MudTh>
            <MudTh>Fiyat</MudTh>
            <MudTh>İşlemler</MudTh>
        </HeaderContent>

        <!-- TABLO SATIRLARI -->
        <RowTemplate Context="house">
            <MudTd>@house.Id</MudTd>

            <MudTd DataLabel="Başlık">
                <MudLink Href="@($"/houses/{house.Id}")">
                    @house.Title
                </MudLink>
            </MudTd>

            <MudTd>@house.City</MudTd>
            <MudTd>@house.Price ₺</MudTd>

            <MudTd>
                <MudIconButton Icon="@Icons.Material.Filled.Edit"
                               Color="Color.Primary"
                               OnClick="@(() => EditHouse(house))" />

                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                               Color="Color.Error"
                               OnClick="@(() => DeleteHouse(house))" />
            </MudTd>
        </RowTemplate>

    </MudTable>

</MudContainer>

@code {

    List<House> _houses = FakeHouseData.GetHouses();

    async Task OpenAddDialog()
    {
        var dialog = DialogService.Show<AddHouseDialog>("Yeni Ev");
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            var newHouse = (House)result.Data!;
            newHouse.Id = _houses.Max(x => x.Id) + 1;
            _houses.Add(newHouse);

            Snackbar.Add("Ev başarıyla eklendi", Severity.Success);
        }
    }

    void DeleteHouse(House house)
    {
        _houses.Remove(house);
        Snackbar.Add($"{house.Title} silindi", Severity.Success);
    }

    async Task EditHouse(House house)
    {
        var parameters = new DialogParameters
        {
            { "Model", house }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };

        var dialog = DialogService.Show<AddHouseDialog>(
            "Ev Güncelle",
            parameters,
            options);

        var result = await dialog.Result;

        if (!result.Canceled)
        {
            var updatedHouse = (House)result.Data!;

            var index = _houses.FindIndex(x => x.Id == updatedHouse.Id);
            if (index != -1)
            {
                _houses[index] = updatedHouse;
            }

            Snackbar.Add("Ev başarıyla güncellendi", Severity.Success);
        }
    }
}
